<Page
    x:Class="AudioPlayerFrontend.MainPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:AudioPlayerFrontend"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:com="using:AudioPlayerBackend.Common"
    xmlns:con="using:StdOttUwp.Converters"
    xmlns:spi="using:StdOttUwp.Converters.Specialized"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}"
    Loaded="Page_Loaded">

    <Page.Resources>
        <local:VolumeToolTipConverter x:Key="volTooTipCon"/>
        <local:PositionToolTipConverter x:Key="posToolTipCon"/>
        <local:IsIMqttAudioConverter x:Key="viewClientSetCon" />

        <con:TimeSpanToStringConverter x:Key="timeStringCon"/>
        <local:TimeSpanToSecondsConverter x:Key="timeSecCon"/>

        <com:PlaybackState x:Key="playingState">Playing</com:PlaybackState>
        <Symbol x:Key="playSym">Play</Symbol>
        <Symbol x:Key="pauseSym">Pause</Symbol>
        <con:IsEnumToValueConverter x:Key="isPlayPauseIconCon"
                                    CompareValue="{StaticResource playingState}" 
                                    EqualsValue="{StaticResource pauseSym}"
                                    NotEqualsValue="{StaticResource playSym}"/>
        <con:IsEnumToValueConverter x:Key="isPlayPauseLabelCon"
                                    CompareValue="{StaticResource playingState}" 
                                    EqualsValue="Pause"
                                    NotEqualsValue="Play"/>

        <spi:VisableCollapsedConverter x:Key="visCon" />
        <spi:CollapsedVisableConverter x:Key="hidCon" />

        <local:LoopIconConverter x:Key="loopIcoCon" />
    </Page.Resources>

    <Grid>
        <Grid Visibility="{Binding IsTryOpening,Converter={StaticResource hidCon}}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <Grid Margin="3" Visibility="{Binding ViewAdvancedSettings,Converter={StaticResource visCon}}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <Grid Margin="5,0" VerticalAlignment="Center"
                      DataContext="{Binding AudioService.Base}" Visibility="{Binding Converter={StaticResource viewClientSetCon}}">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <CheckBox Content="Stream" VerticalAlignment="Center"
                              Margin="0,0,-40,0" IsChecked="{Binding IsStreaming,Mode=TwoWay}"/>
                    <Slider Grid.Column="1" Maximum="1" VerticalAlignment="Center" Margin="0,0,0,-8"
                            SnapsTo="StepValues" StepFrequency="0.01" Value="{Binding ClientVolume}"
                            ThumbToolTipValueConverter="{StaticResource volTooTipCon}"
                            IsEnabled="{Binding IsStreaming}"/>

                </Grid>

                <Button Grid.Column="2" Margin="3" Click="BtnReload_Click">
                    <SymbolIcon Symbol="Refresh"/>
                </Button>
            </Grid>

            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <TextBlock Text="Volume:" VerticalAlignment="Center" Margin="3,3,5,0"/>
                <Slider Grid.Column="1" VerticalAlignment="Center" Margin="0,0,0,-12" SnapsTo="StepValues"
                        StepFrequency="0.01" Maximum="1" Value="{Binding AudioService.Volume,Mode=TwoWay}"
                        ThumbToolTipValueConverter="{StaticResource volTooTipCon}"/>

                <Button Grid.Column="2" Margin="3" Click="BtnLoopType_Click">
                    <SymbolIcon Symbol="{Binding AudioService.CurrentPlaylist.Loop,
                                  Converter={StaticResource loopIcoCon}}"/>
                </Button>

                <ToggleButton Grid.Column="3" Margin="3" IsChecked="{Binding IsShuffle,Mode=TwoWay}">
                    <SymbolIcon Symbol="Shuffle"/>
                </ToggleButton>

                <Button Grid.Column="4" Margin="3" Click="BtnSearch_Click">
                    <SymbolIcon Symbol="Find"/>
                </Button>
            </Grid>

            <con:MultipleInputs2Converter x:Name="mulDoRemove" 
                                          Input0="{Binding AudioService.FileBasePlaylist}"
                                          Input1="{Binding AudioService.CurrentPlaylist}"
                                          Convert="MulDoRemove_Convert"/>

            <ListBox Grid.Row="2" x:Name="lbxSongs" Margin="0,5" HorizontalAlignment="Stretch"
                     DataContext="{Binding AudioService.CurrentPlaylist}"
                     ItemsSource="{Binding ViewSongs}"
                     SelectedIndex="{Binding CurrentViewSongIndex,Mode=TwoWay}"
                     SelectionChanged="LbxSongs_SelectionChanged">
                <ListBox.ItemContainerStyle>
                    <Style TargetType="ListBoxItem">
                        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                    </Style>
                </ListBox.ItemContainerStyle>
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <Grid Margin="0,-8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="5"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <TextBlock Grid.RowSpan="2" TextAlignment="Center" Margin="5,0"
                                       VerticalAlignment="Center" Text="{Binding Index}"/>

                            <TextBlock Grid.Column="2" Grid.Row="0" Text="{Binding Title}"/>
                            <TextBlock Grid.Column="2" Grid.Row="1" Text="{Binding Artist}" FontStyle="Italic"/>

                            <SymbolIcon Grid.Column="3" Grid.RowSpan="2" 
                                        Visibility="{Binding ElementName=mulDoRemove,Path=Output,Converter={StaticResource visCon}}"
                                        Symbol="Remove" Tapped="SyiRemove_Tapped"/>
                        </Grid>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>

            <Grid Grid.Row="3" Margin="1" DataContext="{Binding AudioService.CurrentPlaylist}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <StackPanel DataContext="{Binding CurrentSong}">
                    <TextBlock Text="{Binding Title}" Margin="1" TextWrapping="Wrap"/>
                    <TextBlock Text="{Binding Artist}" FontStyle="Italic" Margin="1" TextWrapping="Wrap"/>
                </StackPanel>
            </Grid>

            <local:AudioPositionSlider Grid.Row="4" Position="{Binding AudioService.CurrentPlaylist.Position,Mode=TwoWay}"
                                       Duration="{Binding AudioService.CurrentPlaylist.Duration}"/>
        </Grid>

        <StackPanel Grid.RowSpan="3" VerticalAlignment="Center" Visibility="{Binding IsTryOpening,Converter={StaticResource visCon}}">
            <TextBlock Text="Opening Service..." FontSize="20" HorizontalAlignment="Center" Margin="5"/>
            <ProgressRing IsActive="True" Height="100" Width="100" Margin="10"/>
            <Button Content="Cancel" Width="100" Margin="5" HorizontalAlignment="Center" Click="BtnCancel_Click"/>
        </StackPanel>
    </Grid>

    <Page.BottomAppBar>
        <CommandBar Visibility="{Binding IsTryOpening,Converter={StaticResource hidCon}}">
            <CommandBar.PrimaryCommands>
                <AppBarButton Icon="Previous" Label="Previous" Click="AbbPrevious_Click"/>
                <AppBarButton Label="{Binding AudioService.PlayState,Converter={StaticResource isPlayPauseLabelCon}}"
                              Click="AbbPlayPause_Click">
                    <AppBarButton.Icon>
                        <SymbolIcon Symbol="{Binding AudioService.PlayState,Converter={StaticResource isPlayPauseIconCon}}"/>
                    </AppBarButton.Icon>
                </AppBarButton>
                <AppBarButton Icon="Next" Label="Next" Click="AbbNext_Click"/>
            </CommandBar.PrimaryCommands>

            <CommandBar.SecondaryCommands>
                <AppBarToggleButton Icon="More" Label="Advanced settings" IsChecked="{Binding ViewAdvancedSettings,Mode=TwoWay}"/>
                <AppBarButton Icon="Setting" Label="All settings" Click="AbbSettings_Click"/>
                <AppBarButton Icon="Admin" Label="Debug" Click="AbbDebug_Click"/>
            </CommandBar.SecondaryCommands>
        </CommandBar>
    </Page.BottomAppBar>
</Page>
